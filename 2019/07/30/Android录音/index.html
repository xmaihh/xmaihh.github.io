<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Android录音 | 小麦</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-131087828-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android录音</h1><a id="logo" href="/.">小麦</a><p class="description">人生的大起大落来得太突然，搞得我直想尿尿...</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android录音</h1><div class="post-meta">2019-07-30<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><a class="disqus-comment-count" href="/2019/07/30/Android%E5%BD%95%E9%9F%B3/#vcomment"><span class="valine-comment-count" data-xid="/2019/07/30/Android%E5%BD%95%E9%9F%B3/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-Android-%E4%B8%AD%E5%BD%95%E9%9F%B3%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">介绍 Android 中录音功能的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%95%E9%9F%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">录音方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">音频参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">编码格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MediaRecorder"><span class="toc-number">1.4.</span> <span class="toc-text">MediaRecorder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AudioRecord"><span class="toc-number">1.5.</span> <span class="toc-text">AudioRecord</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%B9%E5%BD%95%E8%BE%B9%E6%92%AD%EF%BC%88AudioRecord-AudioTrack%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">边录边播（AudioRecord + AudioTrack）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%95%E5%88%B6mp3%E6%A0%BC%E5%BC%8F%E9%9F%B3%E9%A2%91"><span class="toc-number">1.7.</span> <span class="toc-text">录制mp3格式音频</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDlame%E5%BA%93"><span class="toc-number">1.7.1.</span> <span class="toc-text">下载lame库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5"><span class="toc-number">1.7.2.</span> <span class="toc-text">源码导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.3.</span> <span class="toc-text">修改库文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99CmakeList-txt"><span class="toc-number">1.7.4.</span> <span class="toc-text">编写CmakeList.txt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99-java-%E7%B1%BB%E5%92%8C-c-%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.5.</span> <span class="toc-text">编写 java 类和 c 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEbuild-gradle"><span class="toc-number">1.7.6.</span> <span class="toc-text">配置build.gradle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%95%E5%88%B6MP3%E6%A0%BC%E5%BC%8F%E9%9F%B3%E9%A2%91"><span class="toc-number">1.7.7.</span> <span class="toc-text">录制MP3格式音频</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E8%A7%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">音频解码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BD%95%E9%9F%B3%E6%B7%BB%E5%8A%A0%E8%83%8C%E6%99%AF%E9%9F%B3%E4%B9%90%E5%B9%B6%E5%AE%9E%E6%97%B6%E6%92%AD%E6%94%BE%EF%BC%8C%E7%B1%BB%E4%BC%BCK%E6%AD%8C%E6%95%88%E6%9E%9C"><span class="toc-number">3.</span> <span class="toc-text">录音添加背景音乐并实时播放，类似K歌效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="post-content"><h1 id="介绍-Android-中录音功能的实现"><a href="#介绍-Android-中录音功能的实现" class="headerlink" title="介绍 Android 中录音功能的实现"></a>介绍 Android 中录音功能的实现</h1><h2 id="录音方法"><a href="#录音方法" class="headerlink" title="录音方法"></a>录音方法</h2><p>Android 中的录音主要有两种方式 MediaRecorder 和 AudioRecord</p>
<ul>
<li><p>MediaRecorder（基于文件）</p>
<p>  可以录制音、视频；</p>
<p>  封装了录制、编码、压缩、线程等功能，直接生成可播放的音频文件；</p>
<p>  优点：封装度高，操作简单</p>
<p>  缺点：编码格式有限，.aac  .amr  .3gp，但是没有 mp3、wav 格式</p>
</li>
<li><p>AudioRecord（基于字节流）</p>
<p>  ​    只能录制音频；</p>
<p>  ​    输出的是 PCM 的声音数据，如果保存成文件是不能直接播放的，需要编码；</p>
<p>  ​    可以捕获音频流，边录制边处理，比如编码、变声、添加背景音乐。</p>
<p>  ​    优点：更灵活</p>
<p>  ​    缺点：需自行处理编码、开线程等工作</p>
<p>  ​    应用场景：语音聊天、汤姆猫、K歌…</p>
</li>
</ul>
<blockquote>
<p>PCM：Pulse Code Modulation（脉冲编码调制），是对连续变化的模拟信号进行抽样、量化和编码产生的数字信号。<br>它不是一种音频格式，它是声音文件的元数据，也就是声音的内容，没有文件头。经过某种格式的压缩、编码算法处理以后，再加上这种格式的文件头，才是这种格式的音频文件。</p>
</blockquote>
<h2 id="音频参数"><a href="#音频参数" class="headerlink" title="音频参数"></a>音频参数</h2><ul>
<li>采样频率：</li>
</ul>
<p>​       自然界的声音转换成数字格式时，要对它进行采样，每秒钟采样的次数就是采样率。就好比电影的1秒24帧画面。最常用：44.1kHz。</p>
<ul>
<li>采样位数：</li>
</ul>
<p>​       一个采样样本用多少位二进制数编码，最常用：16位。</p>
<ul>
<li>声道数：</li>
</ul>
<p>​       分为单声道和双声道，双声道又叫立体声，双声道音频文件比单声道大一倍。</p>
<ul>
<li>比特率（码率）：</li>
</ul>
<p>​       每秒钟音频文件所占的 bit 数。单位 ：kbps（每秒千比特数）。比特率（原始音频 PCM） = 采样频率 x 采样位数  x  声道数，这是未经压缩的比特率，压缩后会远小于这个值。<br>​<br>​       采用44.1kHz采样频率、16位采样位数、双声道编码的原始音频 PCM 比特率为：1411.2 kbps 。而最常见的 mp3 格式的比特率为：128kbps，约 1MB/分钟。</p>
<ul>
<li>编码格式：</li>
</ul>
<p>​       将原始音频 PCM 采用特定压缩算法处理后，加上文件头，所保存成的文件的格式。例如 mp3、wav、aac…</p>
<h2 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h2><ul>
<li>mp3</li>
</ul>
<p>​       是当今最流行的一种数字音频编码和有损压缩格式，就是将 PCM 通过算法进行压缩，常规 mp3 文件约为 1MB/分钟。</p>
<ul>
<li>aac</li>
</ul>
<p>​        是 mp3 的下一代格式，也是有损压缩，相对于mp3，aac 格式的音频更佳，文件更小。ios 平台也支持，跨平台性好。</p>
<ul>
<li>wav</li>
</ul>
<p>​        最流行的非压缩数据格式，微软开发。</p>
<ul>
<li> amr</li>
</ul>
<p>​        压缩比比较大，但相对其他的压缩格式质量比较差，多用于人声，通话录音。</p>
<blockquote>
<p>riff：一种文件描述的格式，wav文件就采用了riff描述，前面44字节就是 riff 描述内容，就是文件头。</p>
</blockquote>
<h2 id="MediaRecorder"><a href="#MediaRecorder" class="headerlink" title="MediaRecorder"></a>MediaRecorder</h2><p> 首先在 AndroidManifest 配置文件中添加录音权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECORD_AUDIO&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>Android 6.0 以上还要动态获取权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音对象声明</span></span><br><span class="line">   <span class="keyword">private</span> MediaRecorder mRecorder;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startRecording</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 创建录音对象</span></span><br><span class="line">       mRecorder = <span class="keyword">new</span> MediaRecorder();</span><br><span class="line">       <span class="comment">// 设置声音来源 MIC 即手机麦克风</span></span><br><span class="line">       mRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span><br><span class="line">       <span class="comment">// 设置音频格式 aac</span></span><br><span class="line">       mRecorder.setOutputFormat(MediaRecorder.OutputFormat.AAC_ADTS);</span><br><span class="line">       <span class="comment">// 设置录音文件</span></span><br><span class="line">       mRecorder.setOutputFile(getExternalCacheDir() + <span class="string">&quot;/demo.aac&quot;</span>);</span><br><span class="line">       <span class="comment">// 设置编码器</span></span><br><span class="line">       mRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 准备录音</span></span><br><span class="line">           mRecorder.prepare();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 开始录音</span></span><br><span class="line">       mRecorder.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>录音是耗时操作，但是，由于<code>MediaRecorder</code>已经封装了线程，故以上代码放在主线程即可。<br><code>MediaRecorder</code>是很占资源的，使用完毕需要释放掉：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopRecording</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 停止录音</span></span><br><span class="line">       mRecorder.stop();</span><br><span class="line">       <span class="comment">// 释放资源</span></span><br><span class="line">       mRecorder.release();</span><br><span class="line">       <span class="comment">// 引用置空</span></span><br><span class="line">       mRecorder = <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="AudioRecord"><a href="#AudioRecord" class="headerlink" title="AudioRecord"></a>AudioRecord</h2><p>首先在 AndroidManifest 配置文件中添加录音权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECORD_AUDIO&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然 Android 6.0 以上还要动态获取权限，具体实现方式请百度之。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isRecording = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startRecording</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 耗时操作要开线程</span></span><br><span class="line">    <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 音源</span></span><br><span class="line">            <span class="keyword">int</span> audioSource = MediaRecorder.AudioSource.MIC;</span><br><span class="line">            <span class="comment">// 采样率</span></span><br><span class="line">            <span class="keyword">int</span> sampleRate = <span class="number">44100</span>;</span><br><span class="line">            <span class="comment">// 声道数</span></span><br><span class="line">            <span class="keyword">int</span> channelConfig = AudioFormat.CHANNEL_IN_STEREO;<span class="comment">//双声道</span></span><br><span class="line">            <span class="comment">// 采样位数</span></span><br><span class="line">            <span class="keyword">int</span> audioFormat = AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">            <span class="comment">// 获取最小缓存区大小</span></span><br><span class="line">            <span class="keyword">int</span> minBufferSize = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">            <span class="comment">// 创建录音对象</span></span><br><span class="line">            AudioRecord audioRecord = <span class="keyword">new</span> AudioRecord(audioSource, sampleRate, channelConfig, audioFormat, minBufferSize);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建随机读写流</span></span><br><span class="line">                RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="comment">// 留出文件头的位置</span></span><br><span class="line">                raf.seek(<span class="number">44</span>);</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[minBufferSize];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 录音中</span></span><br><span class="line">                audioRecord.startRecording();</span><br><span class="line">                isRecording = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                    <span class="keyword">int</span> readSize = audioRecord.read(buffer, <span class="number">0</span>, minBufferSize);</span><br><span class="line">                    raf.write(buffer,<span class="number">0</span>,readSize);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 录音停止</span></span><br><span class="line">                audioRecord.stop();</span><br><span class="line">                audioRecord.release();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 写文件头</span></span><br><span class="line">                WriteWaveFileHeader(raf, raf.length(),sampleRate,<span class="number">2</span>,sampleRate*<span class="number">16</span>*<span class="number">2</span>/<span class="number">8</span>);</span><br><span class="line">                raf.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为 wav 文件添加文件头，前提是在头部预留了 44字节空间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> raf</span></span><br><span class="line"><span class="comment">     *              随机读写流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileLength</span></span><br><span class="line"><span class="comment">     *              文件总长</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sampleRate</span></span><br><span class="line"><span class="comment">     *              采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channels</span></span><br><span class="line"><span class="comment">     *              声道数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteRate</span></span><br><span class="line"><span class="comment">     *              码率 = 采样率 * 采样位数 * 声道数 / 8</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteWaveFileHeader</span><span class="params">(RandomAccessFile raf, <span class="keyword">long</span> fileLength, <span class="keyword">long</span> sampleRate, <span class="keyword">int</span> channels, <span class="keyword">long</span> byteRate)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> totalDataLen = fileLength + <span class="number">36</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">44</span>];</span><br><span class="line">        header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF/WAVE header</span></span><br><span class="line">        header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">        header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        header[<span class="number">4</span>] = (<span class="keyword">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">5</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">6</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">7</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">        header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">        header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">        header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27; chunk</span></span><br><span class="line">        header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">        header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">        header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">        header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">22</span>] = (<span class="keyword">byte</span>) channels;</span><br><span class="line">        header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">24</span>] = (<span class="keyword">byte</span>) (sampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">25</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">26</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">27</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">28</span>] = (<span class="keyword">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">29</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">30</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">31</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">32</span>] = (<span class="keyword">byte</span>) (<span class="number">2</span> * <span class="number">16</span> / <span class="number">8</span>); <span class="comment">// block align</span></span><br><span class="line">        header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">34</span>] = <span class="number">16</span>; <span class="comment">// bits per sample</span></span><br><span class="line">        header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">        header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">40</span>] = (<span class="keyword">byte</span>) (fileLength &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">41</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">42</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">43</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        raf.seek(<span class="number">0</span>);</span><br><span class="line">        raf.write(header, <span class="number">0</span>, <span class="number">44</span>);</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<p> 以下是停止录音的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopRecording</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 停止录音</span></span><br><span class="line">     isRecording = <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="边录边播（AudioRecord-AudioTrack）"><a href="#边录边播（AudioRecord-AudioTrack）" class="headerlink" title="边录边播（AudioRecord + AudioTrack）"></a>边录边播（AudioRecord + AudioTrack）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> isRecording = <span class="keyword">true</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 耗时操作要开线程</span></span><br><span class="line">       <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 音源</span></span><br><span class="line">               <span class="keyword">int</span> audioSource = MediaRecorder.AudioSource.MIC;</span><br><span class="line">               <span class="comment">// 采样率</span></span><br><span class="line">               <span class="keyword">int</span> sampleRate = <span class="number">8000</span>;</span><br><span class="line">               <span class="comment">// 声道数</span></span><br><span class="line">               <span class="keyword">int</span> channelConfig = AudioFormat.CHANNEL_IN_STEREO;<span class="comment">//双声道</span></span><br><span class="line">               <span class="comment">// 采样位数</span></span><br><span class="line">               <span class="keyword">int</span> audioFormat = AudioFormat.ENCODING_PCM_8BIT;</span><br><span class="line">               <span class="comment">// 获取录音最小缓存区大小</span></span><br><span class="line">               <span class="keyword">int</span> recorderBufferSize = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">               <span class="comment">// 创建录音对象</span></span><br><span class="line">               AudioRecord audioRecord = <span class="keyword">new</span> AudioRecord(audioSource, sampleRate, channelConfig, audioFormat, recorderBufferSize);</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 音频类型</span></span><br><span class="line">               <span class="keyword">int</span> streamType = AudioManager.STREAM_MUSIC;</span><br><span class="line">               <span class="comment">// 静态音频还是音频流</span></span><br><span class="line">               <span class="keyword">int</span> mode = AudioTrack.MODE_STREAM;</span><br><span class="line">               <span class="comment">//  获取播放最小缓存区大小</span></span><br><span class="line">               <span class="keyword">int</span> playerBufferSize = AudioTrack.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">               <span class="comment">// 创建播放对象</span></span><br><span class="line">               AudioTrack audioTrack = <span class="keyword">new</span> AudioTrack(streamType, sampleRate, channelConfig, audioFormat, playerBufferSize, mode);</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 缓存区</span></span><br><span class="line">               <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[recorderBufferSize];</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 录音中</span></span><br><span class="line">               audioTrack.play();</span><br><span class="line">               audioRecord.startRecording();</span><br><span class="line">               isRecording = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                   audioRecord.read(buffer, <span class="number">0</span>, recorderBufferSize);</span><br><span class="line">                   audioTrack.write(buffer, <span class="number">0</span>, buffer.length);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 录音停止</span></span><br><span class="line">               audioRecord.stop();</span><br><span class="line">               audioTrack.stop();</span><br><span class="line">               audioRecord.release();</span><br><span class="line">               audioTrack.release();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p> 停止录音和播放：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 停止录音</span></span><br><span class="line">       isRecording = <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="录制mp3格式音频"><a href="#录制mp3格式音频" class="headerlink" title="录制mp3格式音频"></a>录制mp3格式音频</h2><p> 众多周知，mp3 是跨平台性最好的音频格式，由于采用了压缩率更高的有损压缩算法，文件大小是大约每分钟1M，使其在网络中传输更快，占用存储空间也更少；与此同时，它的声音质量也不错，尤其是人声（相声、评书、脱口秀），当然追求无损音乐的除外。<br> Android 中没有提供录制 mp3 的 API，需要使用开源库 lame，lame 是专门用于编码 mp3 的轻量高效的 c 代码库。由于采用 c 语言编写，故需要用到 jni。</p>
<h3 id="下载lame库"><a href="#下载lame库" class="headerlink" title="下载lame库"></a>下载lame库</h3><ul>
<li>lame库下载(以下使用的是<code>lame</code> v3.100)<br>  <a target="_blank" rel="noopener" href="https://sourceforge.net/projects/lame/files/lame/">https://sourceforge.net/projects/lame/files/lame/</a></li>
</ul>
<h3 id="源码导入"><a href="#源码导入" class="headerlink" title="源码导入"></a>源码导入</h3><p>解压下载的lame库，把<code>libmp3lame</code>文件夹下后缀为<code>.c .h</code>的文件（不包括子文件夹i386和vector下的）复制到cpp/lame文件夹内，同时把<code>include</code>目录下的lame.h也复制到cpp/lame文件夹内，此时 lame文件夹内包含42个文件。<br><img src="https://i.loli.net/2019/07/31/5d4157b88dbd619403.png"><br>（可参考<a target="_blank" rel="noopener" href="https://github.com/xmaihh/MFSocket/tree/master/liblame/src/main/cpp/lame%EF%BC%89">https://github.com/xmaihh/MFSocket/tree/master/liblame/src/main/cpp/lame）</a></p>
<h3 id="修改库文件"><a href="#修改库文件" class="headerlink" title="修改库文件"></a>修改库文件</h3><p>打开刚刚拷贝的lame库文件，修改：</p>
<ol>
<li>util.h 文件，把 570 行的两处 ieee754_float32_t 改为 float  因为Android下并不支持该类型</li>
<li>set_get.h 文件，把头部的 #include &lt;lame.h&gt; 改为 #include “lame.h”</li>
<li>fft.c 文件，删除第47行  #include “vector/lame_intrin.h”</li>
<li>id3tag.c和machine.h两个文件里，將HAVE_STRCHR和HAVE_MEMCPY的ifdef结构体删除或者注释</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> STDC_HEADERS</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">/*# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="comment">#  define strchr index</span></span><br><span class="line"><span class="comment">#  define strrchr rindex</span></span><br><span class="line"><span class="comment"># endif*/</span></span><br><span class="line">char   *strchr(), *strrchr();</span><br><span class="line"><span class="comment">/*# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="comment">#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="comment">#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="comment"># endif*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>可参考以下完整修改文件</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/VbrTag.c b/VbrTag.c</span></span><br><span class="line"><span class="comment">index 5800a44..36ee7b6 100644</span></span><br><span class="line"><span class="comment">--- a/VbrTag.c</span></span><br><span class="line"><span class="comment">+++ b/VbrTag.c</span></span><br><span class="line"><span class="meta">@@ -26,6 +26,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/bitstream.c b/bitstream.c</span></span><br><span class="line"><span class="comment">index aa35915..a2fe294 100644</span></span><br><span class="line"><span class="comment">--- a/bitstream.c</span></span><br><span class="line"><span class="comment">+++ b/bitstream.c</span></span><br><span class="line"><span class="meta">@@ -29,6 +29,7 @@</span></span><br><span class="line"> </span><br><span class="line"> #include &lt;stdlib.h&gt;</span><br><span class="line"> #include &lt;stdio.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> </span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"><span class="comment">diff --git a/encoder.c b/encoder.c</span></span><br><span class="line"><span class="comment">index 48f46c7..437067f 100644</span></span><br><span class="line"><span class="comment">--- a/encoder.c</span></span><br><span class="line"><span class="comment">+++ b/encoder.c</span></span><br><span class="line"><span class="meta">@@ -30,6 +30,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/fft.c b/fft.c</span></span><br><span class="line"><span class="comment">index 4eea1ad..27febdb 100644</span></span><br><span class="line"><span class="comment">--- a/fft.c</span></span><br><span class="line"><span class="comment">+++ b/fft.c</span></span><br><span class="line"><span class="meta">@@ -44,7 +44,7 @@</span></span><br><span class="line"> #include &quot;util.h&quot;</span><br><span class="line"><span class="comment">--- a/fft.c</span></span><br><span class="line"><span class="comment">+++ b/fft.c</span></span><br><span class="line"><span class="meta">@@ -44,7 +44,7 @@</span></span><br><span class="line"> #include &quot;util.h&quot;</span><br><span class="line"> #include &quot;fft.h&quot;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#include &quot;vector/lame_intrin.h&quot;</span></span><br><span class="line"><span class="addition">+//#include &quot;vector/lame_intrin.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/id3tag.c b/id3tag.c</span></span><br><span class="line"><span class="comment">index ac48510..8f148b8 100644</span></span><br><span class="line"><span class="comment">--- a/id3tag.c</span></span><br><span class="line"><span class="comment">+++ b/id3tag.c</span></span><br><span class="line"><span class="meta">@@ -41,17 +41,20 @@</span></span><br><span class="line"> # include &lt;string.h&gt;</span><br><span class="line"> # include &lt;ctype.h&gt;</span><br><span class="line"> #else</span><br><span class="line"><span class="deletion">-# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="deletion">-#  define strchr index</span></span><br><span class="line"><span class="deletion">-#  define strrchr rindex</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="addition">+//#  define strchr index</span></span><br><span class="line"><span class="addition">+//#  define strrchr rindex</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> char   *strchr(), *strrchr();</span><br><span class="line"><span class="deletion">-# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="deletion">-#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="addition">+//#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/lame.c b/lame.c</span></span><br><span class="line"><span class="comment">index cb82225..299fd56 100644</span></span><br><span class="line"><span class="comment">--- a/lame.c</span></span><br><span class="line"><span class="comment">+++ b/lame.c</span></span><br><span class="line"><span class="meta">@@ -31,6 +31,8 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/machine.h b/machine.h</span></span><br><span class="line"><span class="comment">index bf6fff2..c675c20 100644</span></span><br><span class="line"><span class="comment">--- a/machine.h</span></span><br><span class="line"><span class="comment">+++ b/machine.h</span></span><br><span class="line"><span class="meta">@@ -31,15 +31,15 @@</span></span><br><span class="line"> # include &lt;stdlib.h&gt;</span><br><span class="line"> # include &lt;string.h&gt;</span><br><span class="line"> #else</span><br><span class="line"><span class="deletion">-# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="deletion">-#  define strchr index</span></span><br><span class="line"><span class="deletion">-#  define strrchr rindex</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="addition">+//#  define strchr index</span></span><br><span class="line"><span class="addition">+//#  define strrchr rindex</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> char   *strchr(), *strrchr();</span><br><span class="line"><span class="deletion">-# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="deletion">-#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="addition">+//#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #if  defined(__riscos__)  &amp;&amp;  defined(FPA10)</span><br><span class="line"><span class="comment">diff --git a/newmdct.c b/newmdct.c</span></span><br><span class="line"><span class="comment">index 596cac9..ac98abd 100644</span></span><br><span class="line"><span class="comment">--- a/newmdct.c</span></span><br><span class="line"><span class="comment">+++ b/newmdct.c</span></span><br><span class="line"><span class="meta">@@ -30,6 +30,7 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/psymodel.c b/psymodel.c</span></span><br><span class="line"><span class="comment">index 60076ee..1393c2a 100644</span></span><br><span class="line"><span class="comment">--- a/psymodel.c</span></span><br><span class="line"><span class="comment">+++ b/psymodel.c</span></span><br><span class="line"><span class="meta">@@ -145,7 +145,8 @@</span> blocktype_d[2]        block type to use for previous granule</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize.c b/quantize.c</span></span><br><span class="line"><span class="comment">index 9ba9c16..2906c00 100644</span></span><br><span class="line"><span class="comment">--- a/quantize.c</span></span><br><span class="line"><span class="comment">+++ b/quantize.c</span></span><br><span class="line"><span class="meta">@@ -28,6 +28,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize_pvt.c b/quantize_pvt.c</span></span><br><span class="line">:</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize.c b/quantize.c</span></span><br><span class="line"><span class="comment">index 9ba9c16..2906c00 100644</span></span><br><span class="line"><span class="comment">--- a/quantize.c</span></span><br><span class="line"><span class="comment">+++ b/quantize.c</span></span><br><span class="line"><span class="meta">@@ -28,6 +28,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize_pvt.c b/quantize_pvt.c</span></span><br><span class="line"><span class="comment">index d8d6447..3cd9966 100644</span></span><br><span class="line"><span class="comment">--- a/quantize_pvt.c</span></span><br><span class="line"><span class="comment">+++ b/quantize_pvt.c</span></span><br><span class="line"><span class="meta">@@ -36,6 +36,7 @@</span></span><br><span class="line"> #include &quot;reservoir.h&quot;</span><br><span class="line"> #include &quot;lame-analysis.h&quot;</span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> #define NSATHSCALE 100  /* Assuming dynamic range=96dB, this value should be 92 */</span><br><span class="line"><span class="comment">diff --git a/set_get.h b/set_get.h</span></span><br><span class="line"><span class="comment">index 37e4bcd..99ab73c 100644</span></span><br><span class="line"><span class="comment">--- a/set_get.h</span></span><br><span class="line"><span class="comment">+++ b/set_get.h</span></span><br><span class="line"><span class="meta">@@ -21,7 +21,7 @@</span></span><br><span class="line"> #ifndef __SET_GET_H__</span><br><span class="line"> #define __SET_GET_H__</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#include &lt;lame.h&gt;</span></span><br><span class="line"><span class="addition">+#include &quot;lame.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> #if defined(__cplusplus)</span><br><span class="line"> extern  &quot;C&quot; &#123;</span><br><span class="line"><span class="comment">diff --git a/takehiro.c b/takehiro.c</span></span><br><span class="line"><span class="comment">index 67aba1b..ca02f98 100644</span></span><br><span class="line"><span class="comment">--- a/takehiro.c</span></span><br><span class="line"><span class="comment">+++ b/takehiro.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/util.c b/util.c</span></span><br><span class="line"><span class="comment">index 43b457c..e9255fe 100644</span></span><br><span class="line"><span class="comment">--- a/util.c</span></span><br><span class="line"><span class="comment">+++ b/util.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/util.h b/util.h</span></span><br><span class="line"><span class="comment">index 13f0cd4..b6bf306 100644</span></span><br><span class="line"><span class="comment">--- a/util.h</span></span><br><span class="line"><span class="comment">+++ b/util.h</span></span><br><span class="line"><span class="meta">@@ -567,7 +567,7 @@</span> extern  &quot;C&quot; &#123;</span><br><span class="line"> </span><br><span class="line"> /* log/log10 approximations */</span><br><span class="line">     extern void init_log_table(void);</span><br><span class="line"><span class="deletion">-    extern ieee754_float32_t fast_log2(ieee754_float32_t x);</span></span><br><span class="line"><span class="addition">+    extern float fast_log2(float x);</span></span><br><span class="line"> </span><br><span class="line">     int     isResamplingNecessary(SessionConfig_t const* cfg);</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/vbrquantize.c b/vbrquantize.c</span></span><br><span class="line"><span class="comment">index 0f703b7..60834d3 100644</span></span><br><span class="line"><span class="comment">--- a/vbrquantize.c</span></span><br><span class="line"><span class="comment">+++ b/vbrquantize.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,8 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br></pre></td></tr></table></figure>

<h3 id="编写CmakeList-txt"><a href="#编写CmakeList-txt" class="headerlink" title="编写CmakeList.txt"></a>编写CmakeList.txt</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.6</span>.<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span>(CURRENT_DIR <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;CURRENT_DIR:&quot;</span> <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>src/main/cpp/lame)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(LAME_DIR src/main/cpp/lame)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;LAME_DIR:&quot;</span> <span class="variable">$&#123;LAME_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">aux_source_directory</span>(src/main/cpp/lame SRC_LIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(mp3lame</span><br><span class="line">        SHARED</span><br><span class="line">        src/main/cpp/MP3Recorder.c</span><br><span class="line">        <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add_library(mp3lame</span></span><br><span class="line"><span class="comment">#        SHARED</span></span><br><span class="line"><span class="comment">#        src/main/cpp/MP3Recorder.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/bitstream.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/fft.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/id3tag.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/mpglib_interface.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/presets.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/quantize.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/reservoir.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/tables.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/util.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/VbrTag.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/encoder.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/gain_analysis.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/lame.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/newmdct.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/psymodel.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/quantize_pvt.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/set_get.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/takehiro.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/vbrquantize.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/version.c)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">find_library</span>( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">        log-lib</span><br><span class="line">        log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(mp3lame</span><br><span class="line">        <span class="variable">$&#123;log-lib&#125;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（可参考<a target="_blank" rel="noopener" href="https://github.com/xmaihh/MFSocket/blob/master/liblame/CMakeLists.txt%EF%BC%89">https://github.com/xmaihh/MFSocket/blob/master/liblame/CMakeLists.txt）</a></p>
<h3 id="编写-java-类和-c-文件"><a href="#编写-java-类和-c-文件" class="headerlink" title="编写 java 类和 c 文件"></a>编写 java 类和 c 文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MP3Recorder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">     System.loadLibrary(<span class="string">&quot;mp3lame&quot;</span>);   </span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 lame编码器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inSampleRate</span></span><br><span class="line"><span class="comment">     *              输入采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outChannel</span></span><br><span class="line"><span class="comment">     *              声道数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outSampleRate</span></span><br><span class="line"><span class="comment">     *              输出采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outBitrate</span></span><br><span class="line"><span class="comment">     *              比特率(kbps)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> quality</span></span><br><span class="line"><span class="comment">     *              0~9，0最好</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> inSampleRate, <span class="keyword">int</span> outChannel, <span class="keyword">int</span> outSampleRate, <span class="keyword">int</span> outBitrate, <span class="keyword">int</span> quality)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  编码，把 AudioRecord 录制的 PCM 数据转换成 mp3 格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer_l</span></span><br><span class="line"><span class="comment">     *          左声道输入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer_r</span></span><br><span class="line"><span class="comment">     *          右声道输入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> samples</span></span><br><span class="line"><span class="comment">     *          输入数据的size</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mp3buf</span></span><br><span class="line"><span class="comment">     *          输出数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *          输出到mp3buf的byte数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">encode</span><span class="params">(<span class="keyword">short</span>[] buffer_l, <span class="keyword">short</span>[] buffer_r, <span class="keyword">int</span> samples, <span class="keyword">byte</span>[] mp3buf)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  刷写</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mp3buf</span></span><br><span class="line"><span class="comment">     *          mp3数据缓存区</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *          返回刷写的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">flush</span><span class="params">(<span class="keyword">byte</span>[] mp3buf)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭 lame 编码器，释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成.h文件</p>
<p><a target="_blank" rel="noopener" href="https://xmaihh.github.io/2019/07/31/AndroidStudio%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90jni%E5%A4%B4%E6%96%87%E4%BB%B6/">AndroidStudio快速生成jni头文件</a></p>
<p>编写MP3Recorder.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;lame/lame.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MP3Recorder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> lame_global_flags *glf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    init</span></span><br><span class="line"><span class="comment"> * Signature: (IIIII)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_com_android_liblame_MP3Recorder_init</span><br><span class="line">        (JNIEnv *env, jclass instance, jint inSamplerate, jint outChannel, jint outSamplerate,</span><br><span class="line">         jint outBitrate, jint quality) &#123;</span><br><span class="line">    <span class="keyword">if</span> (glf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lame_close(glf);</span><br><span class="line">        glf = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    glf = lame_init();</span><br><span class="line">    lame_set_in_samplerate(glf, inSamplerate);</span><br><span class="line">    lame_set_num_channels(glf, outChannel);</span><br><span class="line">    lame_set_out_samplerate(glf, outSamplerate);</span><br><span class="line">    lame_set_brate(glf, outBitrate);</span><br><span class="line">    lame_set_quality(glf, quality);</span><br><span class="line">    lame_init_params(glf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    encode</span></span><br><span class="line"><span class="comment"> * Signature: ([S[SI[B)I</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jint JNICALL Java_com_android_liblame_MP3Recorder_encode</span><br><span class="line">        (JNIEnv *env, jclass instance, jshortArray buffer_l, jshortArray buffer_r, jint samples,</span><br><span class="line">         jbyteArray mp3buf) &#123;</span><br><span class="line">    jshort *j_buffer_l = (*env)-&gt;GetShortArrayElements(env, buffer_l, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    jshort *j_buffer_r = (*env)-&gt;GetShortArrayElements(env, buffer_r, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> jsize mp3buf_size = (*env)-&gt;GetArrayLength(env, mp3buf);</span><br><span class="line">    jbyte *j_mp3buf = (*env)-&gt;GetByteArrayElements(env, mp3buf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = lame_encode_buffer(glf, j_buffer_l, j_buffer_r,</span><br><span class="line">                                    samples, j_mp3buf, mp3buf_size);</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;ReleaseShortArrayElements(env, buffer_l, j_buffer_l, <span class="number">0</span>);</span><br><span class="line">    (*env)-&gt;ReleaseShortArrayElements(env, buffer_r, j_buffer_r, <span class="number">0</span>);</span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, mp3buf, j_mp3buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    flush</span></span><br><span class="line"><span class="comment"> * Signature: ([B)I</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jint JNICALL Java_com_android_liblame_MP3Recorder_flush</span><br><span class="line">        (JNIEnv *env, jclass instance, jbyteArray mp3buf) &#123;</span><br><span class="line">    <span class="keyword">const</span> jsize mp3buf_size = (*env)-&gt;GetArrayLength(env, mp3buf);</span><br><span class="line">    jbyte *j_mp3buf = (*env)-&gt;GetByteArrayElements(env, mp3buf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = lame_encode_flush(glf, j_mp3buf, mp3buf_size);</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, mp3buf, j_mp3buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    close</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_com_android_liblame_MP3Recorder_close</span><br><span class="line">        (JNIEnv *env, jclass instance) &#123;</span><br><span class="line">    lame_close(glf);</span><br><span class="line">    glf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置build-gradle"><a href="#配置build-gradle" class="headerlink" title="配置build.gradle"></a>配置<code>build.gradle</code></h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">	....</span><br><span class="line">	...</span><br><span class="line">	..</span><br><span class="line">	.</span><br><span class="line">   <span class="comment">//*</span></span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path <span class="string">&quot;CMakeLists.txt&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点一下小锤子 :hammer: MakeProject。</p>
<p>编译生成 so库。</p>
<h3 id="录制MP3格式音频"><a href="#录制MP3格式音频" class="headerlink" title="录制MP3格式音频"></a>录制MP3格式音频</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRecording;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//开始录音</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 音源</span></span><br><span class="line">                <span class="keyword">int</span> audioSource = MediaRecorder.AudioSource.MIC;</span><br><span class="line">                <span class="comment">// 采样率</span></span><br><span class="line">                <span class="keyword">int</span> sampleRate = <span class="number">44100</span>;</span><br><span class="line">                <span class="comment">// 声道</span></span><br><span class="line">                <span class="keyword">int</span> channelConfig = AudioFormat.CHANNEL_IN_MONO;<span class="comment">//单声道</span></span><br><span class="line">                <span class="comment">// 采样位数</span></span><br><span class="line">                <span class="keyword">int</span> audioFormat = AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">                <span class="comment">// 录音缓存区大小</span></span><br><span class="line">                <span class="keyword">int</span> bufferSizeInBytes;</span><br><span class="line">                <span class="comment">// 文件输出流</span></span><br><span class="line">                FileOutputStream fos;</span><br><span class="line">                <span class="comment">// 录音最小缓存大小</span></span><br><span class="line">                bufferSizeInBytes = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">                AudioRecord audioRecord = <span class="keyword">new</span> AudioRecord(audioSource, sampleRate, channelConfig, audioFormat, bufferSizeInBytes);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos = <span class="keyword">new</span> FileOutputStream(getExternalCacheDir() + <span class="string">&quot;/demo.mp3&quot;</span>);</span><br><span class="line">                    MP3Recorder.init(sampleRate, <span class="number">2</span>, sampleRate, <span class="number">128</span>, <span class="number">5</span>);</span><br><span class="line">                    <span class="keyword">short</span>[] buffer = <span class="keyword">new</span> <span class="keyword">short</span>[bufferSizeInBytes];</span><br><span class="line">                    <span class="keyword">byte</span>[] mp3buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) (<span class="number">7200</span> + buffer.length * <span class="number">1.25</span>)];</span><br><span class="line">                    audioRecord.startRecording();</span><br><span class="line">                    isRecording = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">while</span> (isRecording &amp;&amp; audioRecord.getRecordingState() == AudioRecord.RECORDSTATE_RECORDING) &#123;</span><br><span class="line">                        <span class="keyword">int</span> readSize = audioRecord.read(buffer, <span class="number">0</span>, bufferSizeInBytes);</span><br><span class="line">                        <span class="keyword">if</span> (readSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> encodeSize = MP3Recorder.encode(buffer, buffer, readSize, mp3buffer);</span><br><span class="line">                            <span class="keyword">if</span> (encodeSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    fos.write(mp3buffer, <span class="number">0</span>, encodeSize);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">int</span> flushSize = MP3Recorder.flush(mp3buffer);</span><br><span class="line">                    <span class="keyword">if</span> (flushSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            fos.write(mp3buffer, <span class="number">0</span>, flushSize);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fos.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    audioRecord.stop();</span><br><span class="line">                    audioRecord.release();</span><br><span class="line">                    MP3Recorder.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// 停止录音</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isRecording = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="音频解码"><a href="#音频解码" class="headerlink" title="音频解码"></a>音频解码</h1><p> 想要转换音频格式（如 mp3格式转 wav格式）或者添加背景音乐，都需要解码声音文件。<br> Android SDK 中提供了解码的 API，它就是 MediaCodec，也就是音频解码器，我们用它实现 mp3格式音频的解码：<br>把mp3格式转wav格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDecoding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 待解码声音文件路径</span></span><br><span class="line">       String filePath = getExternalCacheDir() + <span class="string">&quot;/bg.mp3&quot;</span>;</span><br><span class="line">       <span class="comment">// 音/视频 提取器</span></span><br><span class="line">       MediaExtractor mediaExtractor = <span class="keyword">new</span> MediaExtractor(); <span class="keyword">try</span> &#123;</span><br><span class="line">           mediaExtractor.setDataSource(filePath);</span><br><span class="line">           <span class="comment">// 分离音频用的，获取音频数据</span></span><br><span class="line">           MediaFormat mediaFormat = mediaExtractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line">         <span class="comment">/*// 获取采样率</span></span><br><span class="line"><span class="comment">           int sampleRate = mediaFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE);</span></span><br><span class="line"><span class="comment">           // 获取声道数</span></span><br><span class="line"><span class="comment">           int channelCount = mediaFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT);</span></span><br><span class="line"><span class="comment">           // 获取时长</span></span><br><span class="line"><span class="comment">           long duration = mediaFormat.getLong(MediaFormat.KEY_DURATION);*/</span></span><br><span class="line">           <span class="comment">// 获取类型</span></span><br><span class="line">           String mime = mediaFormat.getString(MediaFormat.KEY_MIME);</span><br><span class="line">         <span class="comment">/*System.out.println(&quot;sampleRate:&quot; + sampleRate + &quot;,channelCount:&quot; +</span></span><br><span class="line"><span class="comment">           channelCount + &quot;,duration:&quot; + duration + &quot;,mime:&quot; + mime );*/</span></span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 选择音轨</span></span><br><span class="line">           mediaExtractor.selectTrack(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">// 解码器</span></span><br><span class="line">           MediaCodec mediaCodec = MediaCodec.createDecoderByType(mime);</span><br><span class="line">           <span class="comment">// 配置解码器</span></span><br><span class="line">           mediaCodec.configure(mediaFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="comment">// 开始解码</span></span><br><span class="line">           mediaCodec.start();</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 解码器在此缓存中获取输入数据</span></span><br><span class="line">           ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers();</span><br><span class="line">           <span class="comment">// 编码器将解码后的数据放入此缓存中，保存的是pcm数据</span></span><br><span class="line">           ByteBuffer[] outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">           <span class="comment">// 用于描述解码得到的byte[]数据的相关信息</span></span><br><span class="line">           MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 创建随机读写流</span></span><br><span class="line">           RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">           <span class="comment">// 留出文件头的位置</span></span><br><span class="line">           raf.seek(<span class="number">44</span>);</span><br><span class="line">           <span class="comment">// 解码状态</span></span><br><span class="line">           <span class="keyword">boolean</span> isDecoding = <span class="keyword">true</span>;</span><br><span class="line">           main:</span><br><span class="line">           <span class="keyword">while</span> (isDecoding) &#123;</span><br><span class="line">               <span class="keyword">for</span> (ByteBuffer ib : inputBuffers) &#123;</span><br><span class="line">                   <span class="comment">// 获取输入缓存器</span></span><br><span class="line">                   <span class="keyword">int</span> inputIndex = mediaCodec.dequeueInputBuffer(-<span class="number">1</span>);</span><br><span class="line">                   <span class="keyword">if</span> (inputIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">break</span> main;</span><br><span class="line">                   &#125;</span><br><span class="line">                   ByteBuffer inputBuffer = inputBuffers[inputIndex];</span><br><span class="line">                   <span class="comment">// 读取数据到输入缓存器</span></span><br><span class="line">                   <span class="keyword">int</span> sampleSize = mediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">if</span> (sampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                       isDecoding = <span class="keyword">false</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// 通知解码器输入了数据</span></span><br><span class="line">                       mediaCodec.queueInputBuffer(inputIndex, <span class="number">0</span>, sampleSize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                       <span class="comment">// 移动到下一取样处</span></span><br><span class="line">                       mediaExtractor.advance();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 获取输出缓存器</span></span><br><span class="line">               <span class="keyword">int</span> outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               <span class="keyword">if</span> (outputIndex == -<span class="number">2</span>) &#123;</span><br><span class="line">                   <span class="comment">// 格式变了，重新获取一次</span></span><br><span class="line">                   outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">               ByteBuffer outputBuffer;</span><br><span class="line">               <span class="comment">// PCM数据</span></span><br><span class="line">               <span class="keyword">byte</span>[] chunckPCM;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">while</span> (outputIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                   outputBuffer = outputBuffers[outputIndex];</span><br><span class="line">                   <span class="comment">// bufferInfo 定义了次数据块的大小</span></span><br><span class="line">                   chunckPCM = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferInfo.size];</span><br><span class="line">                   <span class="comment">// 将buffer内的数据取出到字节数组中</span></span><br><span class="line">                   outputBuffer.get(chunckPCM);</span><br><span class="line">                   <span class="comment">// 数据取出后，一定记得清空，mediaCodec是反复使用这些buffer的</span></span><br><span class="line">                   outputBuffer.clear();</span><br><span class="line">                   <span class="comment">// 输出PCM数据到文件夹</span></span><br><span class="line">                   raf.write(chunckPCM, <span class="number">0</span>, bufferInfo.size);</span><br><span class="line">                   <span class="comment">// 释放输出buffer，不然mediaCodec用完所有buffer后，就不再向外输出数据</span></span><br><span class="line">                   mediaCodec.releaseOutputBuffer(outputIndex, <span class="keyword">false</span>);</span><br><span class="line">                   <span class="comment">// 再次获取数据,如果没有数据则outputIndex=-1,结束循环</span></span><br><span class="line">                   outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">           WriteWaveFileHeader(raf, raf.length(), <span class="number">44100</span>, <span class="number">1</span>, <span class="number">44100</span> * <span class="number">16</span> / <span class="number">8</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 为 wav 文件添加文件头，前提是在头部预留了 44字节空间</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> raf        随机读写流</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileLength 文件总长</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> sampleRate 采样率</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> channels   声道数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> byteRate   码率 = 采样率 * 采样位数 * 声道数 / 8</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteWaveFileHeader</span><span class="params">(RandomAccessFile raf, <span class="keyword">long</span> fileLength, <span class="keyword">long</span> sampleRate, <span class="keyword">int</span> channels, <span class="keyword">long</span> byteRate)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> totalDataLen = fileLength + <span class="number">36</span>;</span><br><span class="line">       <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">44</span>];</span><br><span class="line">       header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF/WAVE header</span></span><br><span class="line">       header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">       header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">       header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">       header[<span class="number">4</span>] = (<span class="keyword">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">5</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">6</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">7</span>] = (<span class="keyword">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">       header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">       header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">       header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">       header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27; chunk</span></span><br><span class="line">       header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">       header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">       header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">       header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">       header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">       header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">22</span>] = (<span class="keyword">byte</span>) channels;</span><br><span class="line">       header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">24</span>] = (<span class="keyword">byte</span>) (sampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">25</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">26</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">27</span>] = (<span class="keyword">byte</span>) ((sampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">28</span>] = (<span class="keyword">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">29</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">30</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">31</span>] = (<span class="keyword">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">32</span>] = (<span class="keyword">byte</span>) (<span class="number">2</span> * <span class="number">16</span> / <span class="number">8</span>); <span class="comment">// block align</span></span><br><span class="line">       header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">34</span>] = <span class="number">16</span>; <span class="comment">// bits per sample</span></span><br><span class="line">       header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">       header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">       header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">       header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">       header[<span class="number">40</span>] = (<span class="keyword">byte</span>) (fileLength &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">41</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">42</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">43</span>] = (<span class="keyword">byte</span>) ((fileLength &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       raf.seek(<span class="number">0</span>);</span><br><span class="line">       raf.write(header, <span class="number">0</span>, <span class="number">44</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h1 id="录音添加背景音乐并实时播放，类似K歌效果"><a href="#录音添加背景音乐并实时播放，类似K歌效果" class="headerlink" title="录音添加背景音乐并实时播放，类似K歌效果"></a>录音添加背景音乐并实时播放，类似K歌效果</h1><p>K歌类 APP 都是录音加伴奏，这里实现 mp3 格式的背景音乐解码，与录音合并，并最终输出 mp3 格式的文件。即边录音边解码边合成，录音结束即合并结束。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isRecording;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始录音</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 音源</span></span><br><span class="line">            <span class="keyword">int</span> audioSource = MediaRecorder.AudioSource.MIC;</span><br><span class="line">            <span class="comment">// 采样率</span></span><br><span class="line">            <span class="keyword">int</span> sampleRate = <span class="number">44100</span>;</span><br><span class="line">            <span class="comment">// 声道</span></span><br><span class="line">            <span class="keyword">int</span> channelConfig = AudioFormat.CHANNEL_IN_MONO;<span class="comment">//单声道</span></span><br><span class="line">            <span class="comment">// 采样位数</span></span><br><span class="line">            <span class="keyword">int</span> audioFormat = AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">            <span class="comment">// 录音最小缓存区大小</span></span><br><span class="line">            <span class="keyword">int</span> bufferSizeInBytes = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">            <span class="comment">// 录音对象</span></span><br><span class="line">            AudioRecord audioRecord = <span class="keyword">new</span> AudioRecord(audioSource, sampleRate, channelConfig, audioFormat, bufferSizeInBytes);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 音轨提取器</span></span><br><span class="line">                MediaExtractor mediaExtractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">                <span class="comment">// 给音轨提取器设置文件路径</span></span><br><span class="line">                mediaExtractor.setDataSource(getExternalCacheDir() + <span class="string">&quot;/bg.mp3&quot;</span>);</span><br><span class="line">                <span class="comment">// 获取音频格式信息</span></span><br><span class="line">                MediaFormat mediaFormat = mediaExtractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 获取音频类型</span></span><br><span class="line">                String mime = mediaFormat.getString(MediaFormat.KEY_MIME);</span><br><span class="line">                <span class="comment">// 选中音轨</span></span><br><span class="line">                mediaExtractor.selectTrack(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 构造解码器</span></span><br><span class="line">                MediaCodec mediaCodec = MediaCodec.createDecoderByType(mime);</span><br><span class="line">                <span class="comment">// 配置解码器</span></span><br><span class="line">                mediaCodec.configure(mediaFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 开始解码</span></span><br><span class="line">                mediaCodec.start();</span><br><span class="line">                <span class="comment">// 解码器在此缓存中获取输入数据</span></span><br><span class="line">                ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers();</span><br><span class="line">                <span class="comment">// 编码器将解码后的数据放入此缓存中，存放的是pcm数据</span></span><br><span class="line">                ByteBuffer[] outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">                <span class="comment">// 用于描述解码得到的byte[]数据的相关信息</span></span><br><span class="line">                MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">                <span class="comment">// 背景音乐解码后的数据输出流，先存储，然后读取再和录音合并</span></span><br><span class="line">                FileOutputStream fos_wav = <span class="keyword">new</span> FileOutputStream(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>);</span><br><span class="line">                <span class="comment">// 读取处理好的背景音乐，和录音合并</span></span><br><span class="line">                RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="comment">// 背景音字节数</span></span><br><span class="line">                <span class="keyword">long</span> length = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 存储大小端</span></span><br><span class="line">                <span class="keyword">boolean</span> isBigEnding = ByteOrder.nativeOrder() == ByteOrder.BIG_ENDIAN;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 录音缓存</span></span><br><span class="line">                <span class="keyword">short</span>[] buffer = <span class="keyword">new</span> <span class="keyword">short</span>[bufferSizeInBytes];</span><br><span class="line">                <span class="comment">// 最终生成的mp3数据的缓存器</span></span><br><span class="line">                <span class="keyword">byte</span>[] mp3buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) (<span class="number">7200</span> + buffer.length * <span class="number">1.25</span>)];</span><br><span class="line">                <span class="comment">// 开始录音</span></span><br><span class="line">                audioRecord.startRecording();</span><br><span class="line">                <span class="comment">// 录音状态</span></span><br><span class="line">                isRecording = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 最终文件输出流</span></span><br><span class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(getExternalCacheDir() + <span class="string">&quot;/demo.mp3&quot;</span>);</span><br><span class="line">                <span class="comment">// mp3编码器初始化</span></span><br><span class="line">                MP3Recorder.init(sampleRate, <span class="number">1</span>, sampleRate, <span class="number">128</span>, <span class="number">5</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                    <span class="comment">// 读取录音</span></span><br><span class="line">                    <span class="keyword">int</span> readSize = audioRecord.read(buffer, <span class="number">0</span>, bufferSizeInBytes);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 解码背景音乐</span></span><br><span class="line">                    <span class="keyword">for</span> (ByteBuffer ib : inputBuffers) &#123;</span><br><span class="line">                        <span class="comment">// 获取输入缓存器</span></span><br><span class="line">                        <span class="keyword">int</span> inputIndex = mediaCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (inputIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ByteBuffer inputBuffer = inputBuffers[inputIndex];</span><br><span class="line">                        <span class="comment">// 读取数据到输入缓存器</span></span><br><span class="line">                        <span class="keyword">int</span> sampleSize = mediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (sampleSize &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 通知解码器输入了数据</span></span><br><span class="line">                            mediaCodec.queueInputBuffer(inputIndex, <span class="number">0</span>, sampleSize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                            <span class="comment">// 移动到下一取样处</span></span><br><span class="line">                            mediaExtractor.advance();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 输出缓存器</span></span><br><span class="line">                    <span class="keyword">int</span> outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (outputIndex == -<span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="comment">// 格式变了，重新获取一次</span></span><br><span class="line">                        outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                    ByteBuffer outputBuffer;</span><br><span class="line">                    <span class="comment">// PCM数据</span></span><br><span class="line">                    <span class="keyword">byte</span>[] chunckPCM;</span><br><span class="line">                    <span class="comment">// 循环读取解码数据</span></span><br><span class="line">                    <span class="keyword">while</span> (outputIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                        outputBuffer = outputBuffers[outputIndex];</span><br><span class="line">                        <span class="comment">// bufferInfo 定义了数据块的大小</span></span><br><span class="line">                        chunckPCM = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferInfo.size];</span><br><span class="line">                        <span class="comment">// 将buffer内的数据取出到字节数组中</span></span><br><span class="line">                        outputBuffer.get(chunckPCM);</span><br><span class="line">                        <span class="comment">// 数据取出后，一定记得清空，mediaCodec是反复使用这些buffer的</span></span><br><span class="line">                        outputBuffer.clear();</span><br><span class="line">                        <span class="comment">// 输出PCM数据到文件夹</span></span><br><span class="line">                        fos_wav.write(chunckPCM, <span class="number">0</span>, bufferInfo.size);</span><br><span class="line">                        <span class="comment">// 背景音字节数（解码后的）</span></span><br><span class="line">                        length += bufferInfo.size;</span><br><span class="line">                        <span class="comment">// 释放输出buffer，不然mediaCodec用完所有buffer后，就不再向外输出数据</span></span><br><span class="line">                        mediaCodec.releaseOutputBuffer(outputIndex, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="comment">// 再次获取数据,如果没有数据则outputIndex=-1,结束循环</span></span><br><span class="line">                        outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 混音</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; buffer.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (raf.getFilePointer() &gt;= length - <span class="number">1</span>) &#123;</span><br><span class="line">                            raf.seek(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isBigEnding) &#123;</span><br><span class="line">                            buffer[i] += (<span class="keyword">short</span>) ((raf.read() &lt;&lt; <span class="number">8</span>) + raf.read());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            buffer[i] += (<span class="keyword">short</span>) (raf.read() + (raf.read() &lt;&lt; <span class="number">8</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (readSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> encodeSize = MP3Recorder.encode(buffer, buffer, readSize, mp3buffer);</span><br><span class="line">                        <span class="keyword">if</span> (encodeSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                fos.write(mp3buffer, <span class="number">0</span>, encodeSize);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">int</span> flushSize = MP3Recorder.flush(mp3buffer);</span><br><span class="line">                <span class="keyword">if</span> (flushSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fos.write(mp3buffer, <span class="number">0</span>, flushSize);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                    raf.close();</span><br><span class="line">                    fos_wav.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                audioRecord.stop();</span><br><span class="line">                audioRecord.release();</span><br><span class="line">                MP3Recorder.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isRecording = <span class="keyword">false</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="http://blog.elight.cn/?post=200">Android 录音详解（一）—— MediaRecorder、AudioRecord、生成wav格式、边录边播</a><br><a target="_blank" rel="noopener" href="http://blog.elight.cn/?post=201">Android 录音详解（二）—— 录制 mp3 格式音频（ lame 库的编译及使用）</a><br><a target="_blank" rel="noopener" href="http://blog.elight.cn/?post=213">Android 录音详解（三）—— 音频解码</a><br><a target="_blank" rel="noopener" href="http://blog.elight.cn/?post=220">Android 录音详解（四）—— 录音添加背景音乐</a></p>
</div><div class="tags"><a href="/tags/Android/"><i class="fa fa-tag"></i>Android</a></div><div class="post-nav"><a class="pre" href="/2019/07/31/AndroidStudio%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90jni%E5%A4%B4%E6%96%87%E4%BB%B6/">AndroidStudio快速生成jni头文件</a><a class="next" href="/2019/07/19/Ubuntu18-04-2LTS%E4%B8%8BWireshark%E6%8A%A5%E9%94%99Permission-denied/">Ubuntu18.04.2LTS下Wireshark报错Permission denied</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'ncycqYiwBC0WPXrXqROLBhpf-gzGzoHsz',
  appKey:'2xrqDbFCh3xnfMGAYJBisfAT',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android-Framework/">Android Framework</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Raspberry-Pi/">Raspberry Pi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDK%E5%BC%80%E5%8F%91/">SDK开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/">后端技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/ADB/" style="font-size: 15px;">ADB</a> <a href="/tags/BLE/" style="font-size: 15px;">BLE</a> <a href="/tags/Lottie/" style="font-size: 15px;">Lottie</a> <a href="/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/tags/SDK/" style="font-size: 15px;">SDK</a> <a href="/tags/Jni/" style="font-size: 15px;">Jni</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/tags/Debian/" style="font-size: 15px;">Debian</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/Flutter/" style="font-size: 15px;">Flutter</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Camera/" style="font-size: 15px;">Camera</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/ArchLinux/" style="font-size: 15px;">ArchLinux</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/Gdrive/" style="font-size: 15px;">Gdrive</a> <a href="/tags/ZeroTier/" style="font-size: 15px;">ZeroTier</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">微信小程序</a> <a href="/tags/Raspberry-Pi/" style="font-size: 15px;">Raspberry Pi</a> <a href="/tags/Kotlin/" style="font-size: 15px;">Kotlin</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/12/26/%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E5%B1%80%E5%9F%9F%E7%BD%91%E5%86%85%E7%9A%84Android%E6%A8%A1%E6%8B%9F%E5%99%A8/">远程连接局域网内的Android模拟器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/24/%E4%BD%BF%E7%94%A8Kotlin%E7%BC%96%E5%86%99Android%E8%87%AA%E5%AE%9A%E4%B9%89View/">使用Kotlin编写Android自定义View</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/11/Java%E4%B8%ADdouble%E8%BD%ACint%E7%B1%BB%E5%9E%8B%E6%8C%89%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5%E5%8F%96%E6%95%B4/">Java中double转int类型按四舍五入取整</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/Java%E4%BD%8D%E8%BF%90%E7%AE%97(%E7%A7%BB%E4%BD%8D%E3%80%81%E4%B8%8E%E3%80%81%E6%88%96%E3%80%81%E5%BC%82%E6%88%96%E3%80%81%E9%9D%9E)/">Java位运算(移位、与、或、异或、非)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/20/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E5%AE%A1%E6%A0%B8/">小程序开发的内容安全审核</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/13/Flutter%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC%E5%92%8C%E4%BC%A0%E5%80%BC/">Flutter开发中的页面跳转和传值</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/17/%E6%A0%91%E8%8E%93%E6%B4%BE4-Ubuntu18.04.2LTS%E4%B8%8B%E9%85%8D%E7%BD%AEWiFi%E4%B8%8ESSH%E8%BF%9E%E6%8E%A5/">树莓派4-Ubuntu18.04.2LTS下配置WiFi与SSH连接</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/31/AndroidStudio%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90jni%E5%A4%B4%E6%96%87%E4%BB%B6/">AndroidStudio快速生成jni头文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/30/Android%E5%BD%95%E9%9F%B3/">Android录音</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/Ubuntu18-04-2LTS%E4%B8%8BWireshark%E6%8A%A5%E9%94%99Permission-denied/">Ubuntu18.04.2LTS下Wireshark报错Permission denied</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://quincyJiang.github.io" title="瘟疫青年" target="_blank">瘟疫青年</a><ul></ul><a href="https://github.com/xmaihh" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">小麦.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>