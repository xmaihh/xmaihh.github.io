<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>ANR程序问题分析之dropbox | 小麦</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/blog/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-131087828-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ANR程序问题分析之dropbox</h1><a id="logo" href="/blog/.">小麦</a><p class="description">人生的大起大落来得太突然，搞得我直想尿尿...</p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ANR程序问题分析之dropbox</h1><div class="post-meta">2018-07-14<span> | </span><span class="category"><a href="/blog/categories/Android-Framework/">Android Framework</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.9k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/blog/2018/07/14/ANR%E7%A8%8B%E5%BA%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B9%8Bdropbox/#vcomment"><span class="valine-comment-count" data-xid="/blog/2018/07/14/ANR%E7%A8%8B%E5%BA%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B9%8Bdropbox/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%90%AF%E5%8A%A8"><span class="toc-number">1.</span> <span class="toc-text">DropBox启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">DropBox初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init-%E6%96%B9%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">init()方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trimToFit-%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">trimToFit()方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">DropBox工作</span></a></li></ol></div></div><div class="post-content"><p>从2.2开始增加了DropBox功能，增强Android的异常信息收集管理能力DropBox（简称DB）是系统进程中的一个服务，在system_server进程启动时创建，并且它没有运行在单独的线程中，而是运行在system_server的ServerThread线程中。我们可以将ServerThread称作system_server的主线程，ServerThread线程除了启动并维护各个服务外，还负责检测一些重要的服务是否死锁<br>DropBoxManagerService（简称DBMS）就是DB服务的本尊，它的主要功能接口包括以下几个函数：<br>public voidadd(DropBoxManager.Entryentry)</p>
<p>DBMS将所有要添加的日志都用DropBoxManager.Entry类型的对象表示，通过add函数添加，并且直到目前为止一个Entry对象对应着一个日志文件。</p>
<p>publicboolean isTagEnabled(String tag)</p>
<p>通过给每一个Entry设置一个tag可以标识不同类型的日志，并且可以灵活的启用/禁用某种类型的日志，isTagEnabled用来判断指定类型的日志是否被启用/禁用了，一旦禁用就不会再记录这种类型的日志。默认是不禁用任何类型的日志的。稍后说明如何启用/禁用日志。</p>
<p>publicsynchronized DropBoxManager.Entry getNextEntry(String tag, long millis)</p>
<p>我们可以通过getNextEntry函数获取指定类型和指定时间点之后的第一条日志，要使用这个功能应用程序需要有“android.permission.READ_LOGS”的权限，并且在使用完毕返回的Entry对象后要调用其close函数确保关闭日志文件的文件描述符（如果不关闭的话可能造成进程打开的文件描述符超过1024而崩溃，Android中限制每个进程的文件描述符上限为1024）。</p>
<p>DBMS提供了很多的配置项用来限制对磁盘的使用，通过SettingsProvider应用程序维护，数据存放在其settings.db数据库中。这些配置项也都有默认值，罗列如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Settings.Secure.DROPBOX_AGE_SECONDS &#x3D; &quot;dropbox_age_seconds&quot;</span><br><span class="line">&#x2F;&#x2F;日志文件保存的最长时间，默认3天</span><br><span class="line">Settings.Secure.DROPBOX_MAX_FILES &#x3D; &quot;dropbox_max_files&quot;</span><br><span class="line">&#x2F;&#x2F;日志文件的最大数量，默认值是1000</span><br><span class="line">Settings.Secure.DROPBOX_QUOTA_KB &#x3D; &quot;dropbox_quota_kb&quot;</span><br><span class="line">&#x2F;&#x2F;磁盘空间最大使用量</span><br><span class="line">Settings.Secure.DROPBOX_QUOTA_PERCENT &#x3D; &quot;dropbox_quota_percent&quot;</span><br><span class="line">Settings.Secure.DROPBOX_RESERVE_PERCENT &#x3D; &quot;dropbox_reserve_percent&quot;</span><br><span class="line">Settings.Secure.DROPBOX_TAG_PREFIX &#x3D; &quot;dropbox:&quot;</span><br><span class="line">&#x2F;&#x2F;应用程序可以利用DropBox来做事情，收集日志等</span><br></pre></td></tr></table></figure>
<h3 id="DropBox启动"><a href="#DropBox启动" class="headerlink" title="DropBox启动"></a>DropBox启动</h3><p>在SystemServer.java的ServerThread.run()里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Slog.i(TAG, &quot;DropBox Service&quot;);</span><br><span class="line">ServiceManager.addService(Context.DROPBOX_SERVICE, &#x2F;&#x2F;服务名称为“dropbox”</span><br><span class="line">new DropBoxManagerService(context, new File(&quot;&#x2F;data&#x2F;system&#x2F;dropbox&quot;)));</span><br></pre></td></tr></table></figure>
<p>DROPBOX_SERVICE = “dropbox”, “/data/system/dropbox”是DB指定的文件存放位置，这个过程向ServiceManager 登记名为“dropbox”的服务。那么可通过<code>dumpsys dropbox</code>来查看该dropbox服务信息。</p>
<h3 id="DropBox初始化"><a href="#DropBox初始化" class="headerlink" title="DropBox初始化"></a>DropBox初始化</h3><p>在DropBoxManagerService.java的构造方法里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public final class DropBoxManagerService extends IDropBoxManagerService.Stub &#123;</span><br><span class="line"></span><br><span class="line">    public DropBoxManagerService(final Context context, File path) &#123;</span><br><span class="line">        mDropBoxDir &#x3D; path;  &#x2F;&#x2F; 目录&#x2F;data&#x2F;system&#x2F;dropbox</span><br><span class="line">        mContext &#x3D; context;</span><br><span class="line">        mContentResolver &#x3D; context.getContentResolver();</span><br><span class="line"></span><br><span class="line">        IntentFilter filter &#x3D; new IntentFilter();</span><br><span class="line">        &#x2F;&#x2F; 监听存储设备可用空间低的广播</span><br><span class="line">        filter.addAction(Intent.ACTION_DEVICE_STORAGE_LOW);</span><br><span class="line">        &#x2F;&#x2F; 监听开机完毕的广播</span><br><span class="line">        filter.addAction(Intent.ACTION_BOOT_COMPLETED);</span><br><span class="line">        context.registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Settings数据库变化时则回调广播接收者的onReceive方法,此处CONTENT_URI&#x3D;content:&#x2F;&#x2F;settings&#x2F;global&quot;</span><br><span class="line">        mContentResolver.registerContentObserver(</span><br><span class="line">            Settings.Global.CONTENT_URI, true,</span><br><span class="line">            new ContentObserver(new Handler()) &#123;</span><br><span class="line">                public void onChange(boolean selfChange) &#123;</span><br><span class="line">                    mReceiver.onReceive(context, (Intent) null);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        mHandler &#x3D; new Handler() &#123;</span><br><span class="line">            public void handleMessage(Message msg) &#123;</span><br><span class="line">                &#x2F;&#x2F; 发送广播</span><br><span class="line">                if (msg.what &#x3D;&#x3D; MSG_SEND_BROADCAST) &#123;</span><br><span class="line">                    mContext.sendBroadcastAsUser((Intent)msg.obj, UserHandle.OWNER,</span><br><span class="line">                            android.Manifest.permission.READ_LOGS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能是给dropbox目录所对应的存储空间进行瘦身:</p>
<ul>
<li><p>存储设备可用空间低；</p>
</li>
<li><p>开机完毕；</p>
</li>
<li><p>Settings数据库变化；<br>以上情况都会触发触发执行mReceiver的onReceive方法<br>在DropBoxManagerService.java的mReceiver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private final BroadcastReceiver mReceiver &#x3D; new BroadcastReceiver() &#123;</span><br><span class="line">    public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">        if (intent !&#x3D; null &amp;&amp; Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) &#123;</span><br><span class="line">            mBooted &#x3D; true;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;收到ACTION_DEVICE_STORAGE_LOW，则强制重新check存储空间</span><br><span class="line">        mCachedQuotaUptimeMillis &#x3D; 0; </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建工作线程来执行init和trim操作</span><br><span class="line">        new Thread() &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    init(); &#x2F;&#x2F;初始化</span><br><span class="line">                    trimToFit(); &#x2F;&#x2F;清除一些空间</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="init-方法"><a href="#init-方法" class="headerlink" title="init()方法"></a>init()方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void init() throws IOException &#123;</span><br><span class="line">    if (mStatFs &#x3D;&#x3D; null) &#123;</span><br><span class="line">        if (!mDropBoxDir.isDirectory() &amp;&amp; !mDropBoxDir.mkdirs()) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        mStatFs &#x3D; new StatFs(mDropBoxDir.getPath());</span><br><span class="line">        mBlockSize &#x3D; mStatFs.getBlockSize(); &#x2F;&#x2F;mBlockSize&#x3D;4096</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mAllFiles &#x3D;&#x3D; null) &#123;</span><br><span class="line">        File[] files &#x3D; mDropBoxDir.listFiles();</span><br><span class="line">        &#x2F;&#x2F; 列举所有的dropbox文件</span><br><span class="line">        mAllFiles &#x3D; new FileList();</span><br><span class="line">        mFilesByTag &#x3D; new HashMap&lt;String, FileList&gt;();</span><br><span class="line"></span><br><span class="line">        for (File file : files) &#123;</span><br><span class="line">            if (file.getName().endsWith(&quot;.tmp&quot;)) &#123;</span><br><span class="line">                file.delete(); &#x2F;&#x2F;删除后缀为.tmp文件</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 创建dropbox的实体文件对象, 根据文件名来获取相应的时间戳</span><br><span class="line">            EntryFile entry &#x3D; new EntryFile(file, mBlockSize);</span><br><span class="line">            if (entry.tag &#x3D;&#x3D; null) &#123;</span><br><span class="line">                continue; &#x2F;&#x2F;忽略tag为空的文件</span><br><span class="line">            &#125; else if (entry.timestampMillis &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                file.delete(); &#x2F;&#x2F;删除时间戳为0的文件</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;将entry加入到mAllFiles对象</span><br><span class="line">            enrollEntry(entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
</li>
<li><p>创建目录/data/system/dropbox;</p>
</li>
<li><p>将每一个dropbox文件都对应于一个EntryFile对象,根据文件名来获取相应的时间戳</p>
</li>
<li><p>删除后缀为.tmp的文件;</p>
</li>
<li><p>删除时间戳为0的文件</p>
<h4 id="trimToFit-方法"><a href="#trimToFit-方法" class="headerlink" title="trimToFit()方法"></a>trimToFit()方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">private synchronized long trimToFit() &#123;</span><br><span class="line">    int ageSeconds &#x3D; Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_AGE_SECONDS, DEFAULT_AGE_SECONDS);</span><br><span class="line">    int maxFiles &#x3D; Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_MAX_FILES, DEFAULT_MAX_FILES);</span><br><span class="line">    long cutoffMillis &#x3D; System.currentTimeMillis() - ageSeconds * 1000;</span><br><span class="line">    </span><br><span class="line">    while (!mAllFiles.contents.isEmpty()) &#123;</span><br><span class="line">        EntryFile entry &#x3D; mAllFiles.contents.first();</span><br><span class="line">        &#x2F;&#x2F;当最老的文件时间戳在3天之内，且文件个数低于1000，则跳出循环</span><br><span class="line">        if (entry.timestampMillis &gt; cutoffMillis </span><br><span class="line">            &amp;&amp; mAllFiles.contents.size() &lt; maxFiles) break;</span><br><span class="line">        FileList tag &#x3D; mFilesByTag.get(entry.tag);</span><br><span class="line">        if (tag !&#x3D; null &amp;&amp; tag.contents.remove(entry)) tag.blocks -&#x3D; entry.blocks;</span><br><span class="line">        if (mAllFiles.contents.remove(entry)) mAllFiles.blocks -&#x3D; entry.blocks;</span><br><span class="line">        if (entry.file !&#x3D; null) entry.file.delete(); &#x2F;&#x2F;删除文件</span><br><span class="line">    &#125;</span><br><span class="line">    long uptimeMillis &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">    &#x2F;&#x2F;除非接收设备存储低的广播，否则间隔5s才能再次执行restat</span><br><span class="line">    if (uptimeMillis &gt; mCachedQuotaUptimeMillis + QUOTA_RESCAN_MILLIS) &#123;</span><br><span class="line">        int quotaPercent &#x3D; Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_PERCENT, DEFAULT_QUOTA_PERCENT);</span><br><span class="line">        int reservePercent &#x3D; Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_RESERVE_PERCENT, DEFAULT_RESERVE_PERCENT);</span><br><span class="line">        int quotaKb &#x3D; Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_KB, DEFAULT_QUOTA_KB);</span><br><span class="line">        &#x2F;&#x2F;重新统计文件</span><br><span class="line">        mStatFs.restat(mDropBoxDir.getPath());</span><br><span class="line">        int available &#x3D; mStatFs.getAvailableBlocks();</span><br><span class="line">        int nonreserved &#x3D; available - mStatFs.getBlockCount() * reservePercent &#x2F; 100;</span><br><span class="line">        int maximum &#x3D; quotaKb * 1024 &#x2F; mBlockSize;</span><br><span class="line">        &#x2F;&#x2F;可用的块数量</span><br><span class="line">        mCachedQuotaBlocks &#x3D; Math.min(maximum, Math.max(0, nonreserved * quotaPercent &#x2F; 100));</span><br><span class="line">        mCachedQuotaUptimeMillis &#x3D; uptimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    if (mAllFiles.blocks &gt; mCachedQuotaBlocks) &#123;</span><br><span class="line">        &#x2F;&#x2F;公平地限制所有tag的空间</span><br><span class="line">        int unsqueezed &#x3D; mAllFiles.blocks, squeezed &#x3D; 0;</span><br><span class="line">        TreeSet&lt;FileList&gt; tags &#x3D; new TreeSet&lt;FileList&gt;(mFilesByTag.values());</span><br><span class="line">        for (FileList tag : tags) &#123;</span><br><span class="line">            if (squeezed &gt; 0 &amp;&amp; tag.blocks &lt;&#x3D; (mCachedQuotaBlocks - unsqueezed) &#x2F; squeezed) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            unsqueezed -&#x3D; tag.blocks;</span><br><span class="line">            squeezed++;</span><br><span class="line">        &#125;</span><br><span class="line">        int tagQuota &#x3D; (mCachedQuotaBlocks - unsqueezed) &#x2F; squeezed;</span><br><span class="line">        &#x2F;&#x2F;移除每个tags中的旧items</span><br><span class="line">        for (FileList tag : tags) &#123;</span><br><span class="line">            if (mAllFiles.blocks &lt; mCachedQuotaBlocks) break;</span><br><span class="line">            while (tag.blocks &gt; tagQuota &amp;&amp; !tag.contents.isEmpty()) &#123;</span><br><span class="line">                EntryFile entry &#x3D; tag.contents.first();</span><br><span class="line">                if (tag.contents.remove(entry)) tag.blocks -&#x3D; entry.blocks;</span><br><span class="line">                if (mAllFiles.contents.remove(entry)) mAllFiles.blocks -&#x3D; entry.blocks;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (entry.file !&#x3D; null) entry.file.delete();</span><br><span class="line">                    enrollEntry(new EntryFile(mDropBoxDir, entry.tag, entry.timestampMillis));</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    Slog.e(TAG, &quot;Can&#39;t write tombstone file&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return mCachedQuotaBlocks * mBlockSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>trimToFit过程中触发条件是：当文件有效时长超过3天，或者最大文件数超过1000，再或者剩余可用存储设备过低；<br>DBMS有很多常量参数：</p>
</li>
<li><p>DEFAULT_AGE_SECONDS = 3 * 86400：文件最长可存活时长为3天</p>
</li>
<li><p>DEFAULT_MAX_FILES = 1000：最大dropbox文件个数为1000</p>
</li>
<li><p>DEFAULT_QUOTA_KB = 5 * 1024：分配dropbox空间的最大值5M</p>
</li>
<li><p>DEFAULT_QUOTA_PERCENT = 10：是指dropbox目录最多可占用空间比例10%</p>
</li>
<li><p>DEFAULT_RESERVE_PERCENT = 10：是指dropbox不可使用的存储空间比例10%</p>
</li>
<li><p>QUOTA_RESCAN_MILLIS = 5000：重新扫描retrim时长为5s<br>当然上面这些都是默认值，完全可以通过设置content://settings/global数据库中相应项来设定值。</p>
</li>
</ul>
<h3 id="DropBox工作"><a href="#DropBox工作" class="headerlink" title="DropBox工作"></a>DropBox工作</h3><p>以下任一场景，都会调用AMS.addErrorToDropBox()来触发DBMS工作。</p>
<ul>
<li>crash: AMS.handleApplicationCrashInner()</li>
<li>anr: AMS.appNotResponding()</li>
<li>watchdog: Watchdog.run()</li>
<li>native_crash: NativeCrashReporter.run()</li>
<li>wtf: 当调用Log.wtf()或者Log.wtfQuiet()</li>
<li>lowmem: 当内存较低时，触发AMS.reportMemUsage()</li>
</ul>
<p>在ActivityManagerService.java的addErrorToDropBox()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">public void addErrorToDropBox(String eventType, ProcessRecord process, String processName, ActivityRecord activity, ActivityRecord parent, String subject, final String report, final File logFile, final ApplicationErrorReport.CrashInfo crashInfo) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;创建dropbox标签名</span><br><span class="line">    final String dropboxTag &#x3D; processClass(process) + &quot;_&quot; + eventType;</span><br><span class="line">    &#x2F;&#x2F;获取dropbox服务的代理端</span><br><span class="line">    final DropBoxManager dbox &#x3D; (DropBoxManager)</span><br><span class="line">            mContext.getSystemService(Context.DROPBOX_SERVICE);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;当不需要输出dropbox报告则直接返回</span><br><span class="line">    if (dbox &#x3D;&#x3D; null || !dbox.isTagEnabled(dropboxTag)) return;</span><br><span class="line"></span><br><span class="line">    final StringBuilder sb &#x3D; new StringBuilder(1024);</span><br><span class="line">    &#x2F;&#x2F;输出Process,flags,以及进程中所有package</span><br><span class="line">    appendDropBoxProcessHeaders(process, processName, sb);</span><br><span class="line">    ...</span><br><span class="line">    if (subject !&#x3D; null) &#123;</span><br><span class="line">        sb.append(&quot;Subject: &quot;).append(subject).append(&quot;\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(&quot;Build: &quot;).append(Build.FINGERPRINT).append(&quot;\n&quot;);</span><br><span class="line">    sb.append(&quot;\n&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;创建新线程，避免将调用者阻塞在I&#x2F;O</span><br><span class="line">    Thread worker &#x3D; new Thread(&quot;Error dump: &quot; + dropboxTag) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            if (report !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</span><br><span class="line">                sb.append(report); </span><br><span class="line">            &#125;</span><br><span class="line">            if (logFile !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB</span><br><span class="line">                sb.append(FileUtils.readTextFile(logFile, DROPBOX_MAX_SIZE,</span><br><span class="line">                            &quot;\n\n[[TRUNCATED]]&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (crashInfo !&#x3D; null &amp;&amp; crashInfo.stackTrace !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; 比如crash时输出的调用栈</span><br><span class="line">                sb.append(crashInfo.stackTrace);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String setting &#x3D; Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag;</span><br><span class="line">            int lines &#x3D; Settings.Global.getInt(mContext.getContentResolver(), setting, 0);</span><br><span class="line">            &#x2F;&#x2F;当dropboxTag所对应的settings项不等于0，则输出logcat</span><br><span class="line">            if (lines &gt; 0) &#123;</span><br><span class="line">              &#x2F;&#x2F;输出evets&#x2F;system&#x2F;main&#x2F;crash这些log信息</span><br><span class="line">              java.lang.Process logcat &#x3D; new ProcessBuilder(&quot;&#x2F;system&#x2F;bin&#x2F;logcat&quot;,</span><br><span class="line">                      &quot;-v&quot;, &quot;time&quot;, &quot;-b&quot;, &quot;events&quot;, &quot;-b&quot;, &quot;system&quot;, &quot;-b&quot;, &quot;main&quot;,</span><br><span class="line">                      &quot;-b&quot;, &quot;crash&quot;,</span><br><span class="line">                      &quot;-t&quot;, String.valueOf(lines)).redirectErrorStream(true).start();</span><br><span class="line"></span><br><span class="line">              input &#x3D; new InputStreamReader(logcat.getInputStream());</span><br><span class="line"></span><br><span class="line">              int num;</span><br><span class="line">              char[] buf &#x3D; new char[8192];</span><br><span class="line">              &#x2F;&#x2F;不断读取input中的log内容，并添加到sb</span><br><span class="line">              while ((num &#x3D; input.read(buf)) &gt; 0) sb.append(buf, 0, num);</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;将log信息输出到DropBox</span><br><span class="line">            dbox.addText(dropboxTag, sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    if (process &#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F;当进程为空，意味着system_server进程崩溃，系统可能很快就要挂了,</span><br><span class="line">        &#x2F;&#x2F;那么不再创建新线程，而是直接在system_server进程中同步运行</span><br><span class="line">        worker.run();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F;启动新线程</span><br><span class="line">        worker.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能是输出以下内容项：</p>
<ul>
<li>Process,flags, package等头信息；</li>
<li>当report不为空，则比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</li>
<li>当logFile不为空，则比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB；</li>
<li>当stack不为空，则比如crash时输出的调用栈；</li>
<li>输出logcat的events/system/main/crash信息。</li>
</ul>
<p>AMS.processClass()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private static String processClass(ProcessRecord process) &#123;</span><br><span class="line">    &#x2F;&#x2F;MY_PID代表的是当前进程pid，正是system_server进程</span><br><span class="line">    if (process &#x3D;&#x3D; null || process.pid &#x3D;&#x3D; MY_PID) &#123;</span><br><span class="line">        return &quot;system_server&quot;;</span><br><span class="line">    &#125; else if ((process.info.flags &amp; ApplicationInfo.FLAG_SYSTEM) !&#x3D; 0) &#123;</span><br><span class="line">        return &quot;system_app&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return &quot;data_app&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dropbox文件名格式为<a href="mailto:&#100;&#x72;&#x6f;&#112;&#x62;&#111;&#x78;&#x54;&#x61;&#103;&#x40;&#120;&#120;&#x78;&#x2e;&#116;&#x78;&#116;">&#100;&#x72;&#x6f;&#112;&#x62;&#111;&#x78;&#x54;&#x61;&#103;&#x40;&#120;&#120;&#x78;&#x2e;&#116;&#x78;&#116;</a> xxx代表时间戳,例如<a href="mailto:&#115;&#x79;&#115;&#116;&#x65;&#109;&#x5f;&#115;&#101;&#114;&#118;&#101;&#x72;&#95;&#x63;&#114;&#97;&#115;&#x68;&#x40;&#49;&#x34;&#x36;&#x35;&#54;&#x35;&#x30;&#56;&#x34;&#53;&#x33;&#x35;&#x35;&#x2e;&#116;&#120;&#116;">&#115;&#x79;&#115;&#116;&#x65;&#109;&#x5f;&#115;&#101;&#114;&#118;&#101;&#x72;&#95;&#x63;&#114;&#97;&#115;&#x68;&#x40;&#49;&#x34;&#x36;&#x35;&#54;&#x35;&#x30;&#56;&#x34;&#53;&#x33;&#x35;&#x35;&#x2e;&#116;&#120;&#116;</a>,则记录该文件时间戳为1465650845355. 文件后缀除了.txt，还有压缩格式.txt.gz. 对于dropboxTag是由processClass + eventType组合而成.</p>
<p>processClass分为system_server, system_app, data_app;<br>eventType：分为crash,anr,wtf,native_cras,lowmem, watchdog</p>
<p>列举部分常见tags以及含义:</p>
<table>
<thead>
<tr>
<th>dropboxTag</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>system_server_anr</td>
<td>system进程无响应</td>
</tr>
<tr>
<td>system_server_watchdog</td>
<td>system进程发生watchdog</td>
</tr>
<tr>
<td>system_server_crash</td>
<td>system进程崩溃</td>
</tr>
<tr>
<td>system_server_native_crash</td>
<td>system进程native出现崩溃</td>
</tr>
<tr>
<td>system_server_wtf</td>
<td>system进程发生严重错误</td>
</tr>
<tr>
<td>system_server_lowmem</td>
<td>system进程内存不足</td>
</tr>
<tr>
<td>当然除了system_server进程, 还有system_app, data_app类型的进程, 以上所有类型都适用,列举部分:</td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>dropboxTag</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>system_app_crash</td>
<td>系统app崩溃</td>
</tr>
<tr>
<td>system_app_anr</td>
<td>系统app无响应</td>
</tr>
<tr>
<td>data_app_crash</td>
<td>普通app崩溃</td>
</tr>
<tr>
<td>data_app_anr</td>
<td>普通app无响应</td>
</tr>
</tbody></table>
</div><script type="text/javascript" src="/blog/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://xmaihh.github.io/blog/2018/07/14/ANR%E7%A8%8B%E5%BA%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B9%8Bdropbox/" data-id="cklj5k82g0004nosvgo68402f" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAAAAABd2qZ5AAAD7klEQVR42u3ay4rkVhAE0P7/n26DVwNtayIyVIMNR6tCqKSrcxepfHx9xcf338evv3898/Oa5zs8n/n5rHyFt//WBw4cOHDgiG/083i+9XdwtATJU/Lz+TviwIEDB453OZLgml/TBt3b3Z6vb++AAwcOHDj+PMdz+PxNAAsWmt8nCdU4cODAgeO/z5GkYe3L7IW/tz4UcODAgQPHuxxJcXAPt3lprw2it/XjwIEDB45PcNwGGv5fvz8+34EDBw4cOOJxhGVAYQ+0baq5vB0OHDhw4Ng5ntOkJSq1RbocNE/t2uEGHDhw4MDxFke7rOTMjfLWOkrSzhYRBw4cOHDsHPnQwBJcl2GIBH0P8zhw4MCBY+HIhwD2RCtPt27/bTf4H67BgQMHDhwzR7Ks5AH5a7Rhu4XIg/G/PgUHDhw4cAwcy4vl4wX5MEGbtuVFxuK7AwcOHDhwzBx5Ia8t/OVtofy5bdmx2EIcOHDgwPESx16YuyVgC0He7qrbTjhw4MCBY+D4RIkt/1e+3NtIRJLC4cCBAweOdznaYbjbYNwt9Ur+lV8TbTkOHDhw4Jg58gC5NIHaQbqc77aFUbjFgQMHDhwnjqU42CZvbXNomf47NsBw4MCBA8c7swR1HfE2JDctbv5EyFtTOHDgwIFj4bgV6dq20H7/JXwW68eBAwcOHC9xtM2k28OWEerbsEK9SThw4MCB4wMcyyKWkmLSQFqKjNE24MCBAweOlziWQltSqltKeC3ENJaBAwcOHDhmjuTSdjDueYm3gmCyqjzMJ8Q4cODAgWPnaAeXbyW/JJ27fQosEDhw4MCB4y2OpCS3LP2WKObBPtnOYuU4cODAgeOdlX+1C701k/LweeNrPxp+c2ccOHDgwHHiyAt/yVL2YYUcpQ3VUZsKBw4cOHDMHMkSE7g8ZLYjBXliGXXVkoQQBw4cOHAMHPmt217WEhQTpluLK6qV4sCBAweOOW7eRtlapltYbZ97a57hwIEDB463OJKWfxvM2sTpltq1AThK9nDgwIEDx6sc+WDBraXUtqnalli7/q9bDMeBAwcOHAHHnlDlBbud7PY7Kk3iwIEDB46Z4znJuSVCt/D5cjK2tKxw4MCBA8fA8V0eeTqXL6htceVMbUKIAwcOHDh2js8FvLxZtTelllTwFqRx4MCBA8czRx5c2/CZj0G0RcZ2Y4phCxw4cODA8RJHGwjzYuLSCroNW0wbhgMHDhw4/jjHLa263SFPLNsSZD0whwMHDhw4PsDRtnbyl2zDdr4BRfKGAwcOHDhe5ciHGJIAlg8ofLpEWF+JAwcOHDhmjnag4flMjpi3jlrEfRtw4MCBA8eJ4y8MHI+iKWlgVAAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/blog/tags/Android/"><i class="fa fa-tag"></i>Android</a></div><div class="post-nav"><a class="pre" href="/blog/2018/07/15/Watchdog%E6%9C%BA%E5%88%B6/">Watchdog机制</a><a class="next" href="/blog/2018/07/13/ANR%E7%A8%8B%E5%BA%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B9%8Btraces/">ANR程序问题分析之traces</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'ncycqYiwBC0WPXrXqROLBhpf-gzGzoHsz',
  appKey:'2xrqDbFCh3xnfMGAYJBisfAT',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Android-Framework/">Android Framework</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/C-C/">C/C++</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Flutter/">Flutter</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Raspberry-Pi/">Raspberry Pi</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/SDK%E5%BC%80%E5%8F%91/">SDK开发</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/">后端技术</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/Android/" style="font-size: 15px;">Android</a> <a href="/blog/tags/ADB/" style="font-size: 15px;">ADB</a> <a href="/blog/tags/BLE/" style="font-size: 15px;">BLE</a> <a href="/blog/tags/SDK/" style="font-size: 15px;">SDK</a> <a href="/blog/tags/Lottie/" style="font-size: 15px;">Lottie</a> <a href="/blog/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/blog/tags/Jni/" style="font-size: 15px;">Jni</a> <a href="/blog/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/blog/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/blog/tags/Debian/" style="font-size: 15px;">Debian</a> <a href="/blog/tags/Flutter/" style="font-size: 15px;">Flutter</a> <a href="/blog/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/blog/tags/Java/" style="font-size: 15px;">Java</a> <a href="/blog/tags/Camera/" style="font-size: 15px;">Camera</a> <a href="/blog/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/blog/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/blog/tags/ArchLinux/" style="font-size: 15px;">ArchLinux</a> <a href="/blog/tags/Python/" style="font-size: 15px;">Python</a> <a href="/blog/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/blog/tags/Gdrive/" style="font-size: 15px;">Gdrive</a> <a href="/blog/tags/ZeroTier/" style="font-size: 15px;">ZeroTier</a> <a href="/blog/tags/Git/" style="font-size: 15px;">Git</a> <a href="/blog/tags/Kotlin/" style="font-size: 15px;">Kotlin</a> <a href="/blog/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">微信小程序</a> <a href="/blog/tags/Raspberry-Pi/" style="font-size: 15px;">Raspberry Pi</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2019/12/26/%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E5%B1%80%E5%9F%9F%E7%BD%91%E5%86%85%E7%9A%84Android%E6%A8%A1%E6%8B%9F%E5%99%A8/">远程连接局域网内的Android模拟器</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/12/24/%E4%BD%BF%E7%94%A8Kotlin%E7%BC%96%E5%86%99Android%E8%87%AA%E5%AE%9A%E4%B9%89View/">使用Kotlin编写Android自定义View</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/12/11/Java%E4%B8%ADdouble%E8%BD%ACint%E7%B1%BB%E5%9E%8B%E6%8C%89%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5%E5%8F%96%E6%95%B4/">Java中double转int类型按四舍五入取整</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/11/05/Java%E4%BD%8D%E8%BF%90%E7%AE%97(%E7%A7%BB%E4%BD%8D%E3%80%81%E4%B8%8E%E3%80%81%E6%88%96%E3%80%81%E5%BC%82%E6%88%96%E3%80%81%E9%9D%9E)/">Java位运算(移位、与、或、异或、非)</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/10/20/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E5%AE%A1%E6%A0%B8/">小程序开发的内容安全审核</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/10/13/Flutter%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC%E5%92%8C%E4%BC%A0%E5%80%BC/">Flutter开发中的页面跳转和传值</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/09/17/%E6%A0%91%E8%8E%93%E6%B4%BE4-Ubuntu18.04.2LTS%E4%B8%8B%E9%85%8D%E7%BD%AEWiFi%E4%B8%8ESSH%E8%BF%9E%E6%8E%A5/">树莓派4-Ubuntu18.04.2LTS下配置WiFi与SSH连接</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/07/31/AndroidStudio%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90jni%E5%A4%B4%E6%96%87%E4%BB%B6/">AndroidStudio快速生成jni头文件</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/07/30/Android%E5%BD%95%E9%9F%B3/">Android录音</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/07/19/Ubuntu18-04-2LTS%E4%B8%8BWireshark%E6%8A%A5%E9%94%99Permission-denied/">Ubuntu18.04.2LTS下Wireshark报错Permission denied</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://quincyJiang.github.io" title="瘟疫青年" target="_blank">瘟疫青年</a><ul></ul><a href="https://github.com/xmaihh" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/blog/." rel="nofollow">小麦.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/blog/css/search.css?v=1.0.0"><script type="text/javascript" src="/blog/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/blog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script></div></body></html>